<!DOCTYPE html>
<html>
<head>
    <title>CIP Bulk Upload</title>
    <style>
        :root {
            color-scheme: light;
            --ink: #1c2a3a;
            --muted: #6b7a8c;
            --paper: #f3f6fb;
            --card: #ffffff;
            --accent: #0a4cc7;
            --accent-2: #2f6dd5;
            --line: #d9e2ee;
            --shadow: 0 14px 30px rgba(20, 40, 70, 0.12);
        }
        .theme-dark {
            color-scheme: dark;
            --ink: #e9f1ff;
            --muted: #a9b9d1;
            --paper: #0b1422;
            --card: #121c2c;
            --accent: #4b83ff;
            --accent-2: #6aa2ff;
            --line: #223247;
            --shadow: 0 16px 34px rgba(0, 0, 0, 0.45);
        }
        body {
            font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", sans-serif;
            margin: 0;
            min-height: 100vh;
            background:
                radial-gradient(circle at 15% 10%, rgba(10, 76, 199, 0.12), transparent 45%),
                radial-gradient(circle at 85% 12%, rgba(47, 109, 213, 0.16), transparent 40%),
                linear-gradient(140deg, #f2f6fb 0%, #f6f8fc 45%, #eef3fa 100%);
            color: var(--ink);
        }
        body.theme-dark {
            background:
                radial-gradient(circle at 15% 10%, rgba(75, 131, 255, 0.18), transparent 45%),
                radial-gradient(circle at 85% 12%, rgba(106, 162, 255, 0.2), transparent 40%),
                linear-gradient(140deg, #0b1320 0%, #101a2a 45%, #0b1422 100%);
        }
        .page {
            max-width: 1100px;
            margin: 0 auto;
            padding: 48px 32px 80px;
        }
        h2 {
            margin: 0 0 8px;
            font-size: 28px;
            letter-spacing: 0.4px;
        }
        .sub {
            color: var(--muted);
            margin-bottom: 28px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1.4px;
        }
        .card {
            background: var(--card);
            border: 1px solid var(--line);
            padding: 28px;
            border-radius: 18px;
            box-shadow: var(--shadow);
        }
        label {
            display: block;
            margin-top: 14px;
            font-weight: 600;
        }
        input, select, textarea {
            width: 100%;
            max-width: 480px;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #d3deef;
            background: #ffffff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        body.theme-dark input,
        body.theme-dark select,
        body.theme-dark textarea {
            border-color: #223247;
            background: #101a2a;
            color: var(--ink);
        }
        textarea {
            max-width: 700px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: rgba(10, 76, 199, 0.65);
            box-shadow: 0 0 0 3px rgba(10, 76, 199, 0.18);
        }
        .help {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }
        button {
            margin-top: 22px;
            padding: 10px 14px;
            border-radius: 999px;
            border: none;
            background: var(--accent);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(10, 76, 199, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 26px rgba(10, 76, 199, 0.28);
        }
        .secondary-button {
            background: var(--accent-2);
            box-shadow: 0 10px 20px rgba(47, 109, 213, 0.22);
        }
        .secondary-button:hover {
            box-shadow: 0 12px 26px rgba(47, 109, 213, 0.3);
        }
        .alert {
            margin-bottom: 16px;
            padding: 12px 14px;
            border-radius: 12px;
            font-size: 14px;
        }
        .alert.error {
            background: #ffe5e0;
            border: 1px solid #e9a8a0;
            color: #7a1f17;
            animation: shake 0.35s ease;
        }
        body.theme-dark .alert.error {
            background: #3a1a17;
            border-color: #7a3a30;
            color: #ffb7aa;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            50% { transform: translateX(4px); }
            75% { transform: translateX(-3px); }
            100% { transform: translateX(0); }
        }
        .stores-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(240px, 1fr));
            gap: 8px 16px;
            margin-top: 8px;
            padding: 12px;
            border: 1px dashed #d6e0ef;
            border-radius: 14px;
            background: #f7f9fd;
            max-width: 700px;
        }
        body.theme-dark .stores-grid {
            background: #0f1a2a;
            border-color: #223247;
        }
        .store-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            padding: 6px 8px;
            border-radius: 10px;
            justify-content: space-between;
        }
        .store-item span {
            display: flex;
            justify-content: space-between;
            width: 100%;
            gap: 12px;
        }
        .store-name {
            flex: 1;
        }
        .store-number {
            font-weight: 700;
            color: var(--muted);
        }
        .store-item.selected {
            background: rgba(10, 76, 199, 0.12);
            border: 1px solid rgba(10, 76, 199, 0.35);
        }
        body.theme-dark .store-item.selected {
            background: rgba(75, 131, 255, 0.18);
            border-color: rgba(75, 131, 255, 0.35);
        }
        .store-item.disabled {
            opacity: 0.45;
        }
        .store-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .store-actions button {
            margin-top: 0;
            background: #7a4f2a;
            box-shadow: 0 8px 16px rgba(122, 79, 42, 0.2);
        }
        .store-output {
            margin-top: 10px;
        }
        .grid-wrapper {
            margin-top: 12px;
            border: 1px solid #e3d4be;
            border-radius: 14px;
            padding: 12px;
            background: #fffdf8;
        }
        body.theme-dark .grid-wrapper {
            background: #0f1a2a;
            border-color: #223247;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            border-bottom: 1px solid #eadfce;
            text-align: left;
        }
        th {
            font-size: 13px;
            color: #5a4b3b;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }
        .row-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .row-actions button {
            margin-top: 0;
            background: #7fa6e8;
            box-shadow: 0 8px 16px rgba(127, 166, 232, 0.25);
        }
        .small-input {
            max-width: 240px;
        }
        .section {
            margin-top: 18px;
            padding: 16px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.75);
            border: 1px solid #e2e9f4;
        }
        body.theme-dark .section {
            background: rgba(18, 28, 44, 0.85);
            border-color: #223247;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 8px;
        }
        .section-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--accent);
            box-shadow: 0 0 0 4px rgba(10, 76, 199, 0.12);
        }
        .hero {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 24px;
        }
        .hero-badge {
            background: rgba(42, 111, 95, 0.12);
            color: var(--accent);
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.6px;
        }
        @media (max-width: 800px) {
            .page {
                padding: 32px 20px 60px;
            }
            .hero {
                flex-direction: column;
            }
            .card {
                padding: 22px;
            }
        }
        .fade-in {
            animation: fadeInUp 0.8s cubic-bezier(0.2, 0.6, 0.2, 1) both;
        }
        .fade-in.delay-1 {
            animation-delay: 0.12s;
        }
        .fade-in.delay-2 {
            animation-delay: 0.24s;
        }
        .fade-in.delay-3 {
            animation-delay: 0.36s;
        }
        .fade-in.delay-4 {
            animation-delay: 0.48s;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(18px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .subtle-float {
            animation: floatIn 1.2s ease both;
        }
        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .field-pop {
            animation: fieldPop 0.6s ease both;
        }
        @keyframes fieldPop {
            from { transform: translateY(6px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .theme-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.7);
            color: var(--ink);
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.6px;
            cursor: pointer;
        }
        body.theme-dark .theme-toggle {
            background: rgba(36, 31, 25, 0.8);
            border-color: #3a3126;
        }
    </style>
</head>
<body>

<div class="page">
    <div class="hero fade-in">
        <div>
            <h2>CIP Bulk Upload Generator</h2>
            <div class="sub">Steps 1-4: header, store selection, article grid, CSV export.</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-end;">
            <div class="hero-badge subtle-float">CIP Bulk Tool</div>
            <button type="button" id="theme-toggle" class="theme-toggle">Toggle Dark Mode</button>
        </div>
    </div>

    <div class="card fade-in delay-1" style="margin-bottom:16px;">
        <div class="section-header"><span class="section-dot"></span>Quick Tips</div>
        <div class="help">For percentage types, enter whole numbers (e.g., 10 = 10%). CC forces All variants/bundles to FALSE.</div>
        <div class="help">Paste multiple rows from Excel using the Bulk paste box.</div>
    </div>

    <div class="card fade-in delay-1">
        {% if errors %}
            <div class="alert error fade-in delay-2">
                <strong>Please fix the following:</strong>
                <ul>
                    {% for error in errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <form method="post" action="/generate">
            <div class="section fade-in delay-2 field-pop">
                <div class="section-header"><span class="section-dot"></span>Header</div>
                <label>Customer home store</label>
                <select name="customer_home_store" required>
                    <option value="">Select store</option>
                    {% for store in home_stores %}
                        <option value="{{ store }}" {% if form.get('customer_home_store') == store %}selected{% endif %}>{{ store }}</option>
                    {% endfor %}
                </select>

                <label>Customer number</label>
                <input name="customer_number" inputmode="numeric" pattern="\d{1,6}" maxlength="6" value="{{ form.get('customer_number','') }}" required>
                <div class="help">Max 6 digits</div>

                <label>Salesline</label>
                <select name="salesline" id="salesline" required>
                    <option value="">Select salesline</option>
                    {% for item in sales_lines %}
                        <option value="{{ item }}" {% if form.get('salesline') == item %}selected{% endif %}>{{ item }}</option>
                    {% endfor %}
                </select>

                <label>Article identifier type</label>
                <select name="article_identifier_type" required>
                    <option value="">Select identifier type</option>
                    {% for item in article_identifier_types %}
                        <option value="{{ item }}" {% if form.get('article_identifier_type') == item %}selected{% endif %}>{{ item }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="section fade-in delay-3 field-pop">
                <div class="section-header"><span class="section-dot"></span>Stores</div>
                <label>CIP store(s)</label>
                <div class="help">Pick one store for the selected salesline.</div>
                <div class="store-actions">
                    <button type="button" data-action="clear-all">Clear</button>
                </div>
                <div class="stores-grid">
                    {% for store in stores %}
                    <label class="store-item" data-store-wrapper>
                        <input type="radio" name="cip_store_choice" class="store-radio" data-store="{{ store.number }}" data-groups="{{ store.groups | join(',') }}" {% if form.get('cip_stores','') == store.number %}checked{% endif %}>
                        <span><span class="store-name">{{ store.name }}</span><span class="store-number">{{ store.number }}</span></span>
                    </label>
                    {% endfor %}
                </div>
                <div class="store-output">
                    <input name="cip_stores" id="cip_stores" placeholder="Auto-generated" value="{{ form.get('cip_stores','') }}" readonly required>
                </div>
            </div>

            <div class="section fade-in delay-3 field-pop">
                <div class="section-header"><span class="section-dot"></span>Flags & Type</div>
                <label>Exclusive CIP</label>
                <select name="exclusive_cip" required>
                    <option value="">Select</option>
                    {% for item in boolean_choices %}
                        <option value="{{ item }}" {% if form.get('exclusive_cip') == item %}selected{% endif %}>{{ item }}</option>
                    {% endfor %}
                </select>

                <label>All variants</label>
                <select name="all_variants" required>
                    <option value="">Select</option>
                    {% for item in boolean_choices %}
                        <option value="{{ item }}" {% if form.get('all_variants') == item %}selected{% endif %}>{{ item }}</option>
                    {% endfor %}
                </select>

                <label>All bundles</label>
                <select name="all_bundles" required>
                    <option value="">Select</option>
                    {% for item in boolean_choices %}
                        <option value="{{ item }}" {% if form.get('all_bundles') == item %}selected{% endif %}>{{ item }}</option>
                    {% endfor %}
                </select>

                <label>CIP type</label>
                <select name="cip_type" required>
                    <option value="">Select CIP type</option>
                    {% for item in cip_types %}
                        <option value="{{ item }}" {% if form.get('cip_type') == item %}selected{% endif %}>{{ item }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="section fade-in delay-4 field-pop">
                <div class="section-header"><span class="section-dot"></span>Dates & Reason</div>
                <label>From date</label>
                <input type="date" name="from_date" value="{{ form.get('from_date','') }}" required>

                <label>To date</label>
                <input type="date" name="to_date" value="{{ form.get('to_date','') }}" required>

                <label>Reason</label>
                <select name="cip_reason_type" required>
                    <option value="">Select reason</option>
                    {% for item in cip_reason_types %}
                        <option value="{{ item }}" {% if form.get('cip_reason_type') == item %}selected{% endif %}>{{ item }}</option>
                    {% endfor %}
                </select>

                <label>Reason detail</label>
                <input name="cip_reason_detail" value="{{ form.get('cip_reason_detail','') }}">
                <div class="help">Required only when Reason is OTHER_REASON</div>
            </div>

            <div class="section fade-in delay-4 field-pop">
                <div class="section-header"><span class="section-dot"></span>Articles</div>
                <label>Articles and CIP values</label>
                <div class="help">Enter at least one row. Values must be numeric.</div>
                <div class="grid-wrapper">
                    <label>Bulk paste (Article #, CIP value)</label>
                    <div class="help">Paste directly from Excel (two columns) or use: 12345,10 / 12345;10 / 12345<Tab>10</div>
                    <textarea id="bulk-paste" rows="4"></textarea>
                    <div class="row-actions">
                        <button type="button" id="paste-rows">Paste rows</button>
                    </div>
                    <table id="article-table">
                        <thead>
                            <tr>
                                <th>Row</th>
                                <th>Article #</th>
                                <th>CIP value</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if article_rows %}
                                {% for row in article_rows %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td><input class="small-input" name="article_number" value="{{ row.article_number }}" required></td>
                                    <td><input class="small-input" name="cip_value" value="{{ row.cip_value }}" required></td>
                                    <td><button type="button" class="remove-row">Remove</button></td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td>1</td>
                                    <td><input class="small-input" name="article_number" required></td>
                                    <td><input class="small-input" name="cip_value" required></td>
                                    <td><button type="button" class="remove-row">Remove</button></td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                    <div class="row-actions">
                        <button type="button" id="add-row">Add row</button>
                        <button type="button" id="clear-rows">Clear rows</button>
                    </div>
                </div>
            </div>

            <button type="submit">Generate CSV</button>
        </form>
    </div>
</div>

<script>
    const radios = Array.from(document.querySelectorAll('.store-radio'));
    const output = document.getElementById('cip_stores');
    const saleslineSelect = document.getElementById('salesline');

    function updateOutput() {
        const selected = radios.find(radio => radio.checked);
        output.value = selected ? selected.dataset.store : '';
    }

    function updateStoreAvailability() {
        const salesline = saleslineSelect.value;
        radios.forEach(radio => {
            const groups = radio.dataset.groups.split(',');
            const isAllowed = salesline ? groups.includes(salesline.toLowerCase()) : true;
            radio.disabled = !isAllowed;
            const wrapper = radio.closest('[data-store-wrapper]');
            if (!isAllowed) {
                radio.checked = false;
                wrapper.classList.add('disabled');
                wrapper.classList.remove('selected');
            } else {
                wrapper.classList.remove('disabled');
            }
        });
        updateOutput();
    }

    function syncSelectedStyles() {
        radios.forEach(radio => {
            const wrapper = radio.closest('[data-store-wrapper]');
            if (radio.checked) {
                wrapper.classList.add('selected');
            } else {
                wrapper.classList.remove('selected');
            }
        });
    }

    radios.forEach(radio => radio.addEventListener('change', () => {
        updateOutput();
        syncSelectedStyles();
    }));

    document.querySelector('[data-action="clear-all"]').addEventListener('click', () => {
        radios.forEach(radio => radio.checked = false);
        updateOutput();
        syncSelectedStyles();
    });

    saleslineSelect.addEventListener('change', updateStoreAvailability);

    updateStoreAvailability();
    syncSelectedStyles();

    const tableBody = document.querySelector('#article-table tbody');
    const addRowButton = document.getElementById('add-row');
    const clearRowsButton = document.getElementById('clear-rows');
    const bulkPaste = document.getElementById('bulk-paste');
    const pasteRowsButton = document.getElementById('paste-rows');
    const allVariantsSelect = document.querySelector('select[name="all_variants"]');
    const allBundlesSelect = document.querySelector('select[name="all_bundles"]');

    function renumberRows() {
        Array.from(tableBody.querySelectorAll('tr')).forEach((row, index) => {
            row.querySelector('td').textContent = index + 1;
        });
    }

    function addRow(articleValue = '', cipValue = '') {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td></td>
            <td><input class="small-input" name="article_number" required></td>
            <td><input class="small-input" name="cip_value" required></td>
            <td><button type="button" class="remove-row">Remove</button></td>
        `;
        const inputs = row.querySelectorAll('input');
        inputs[0].value = articleValue;
        inputs[1].value = normalizeDecimalInput(cipValue);
        tableBody.appendChild(row);
        renumberRows();
    }

    tableBody.addEventListener('click', (event) => {
        if (event.target.classList.contains('remove-row')) {
            const rows = tableBody.querySelectorAll('tr');
            if (rows.length > 1) {
                event.target.closest('tr').remove();
                renumberRows();
            } else {
                rows[0].querySelectorAll('input').forEach(input => input.value = '');
            }
        }
    });

    addRowButton.addEventListener('click', () => addRow());

    clearRowsButton.addEventListener('click', () => {
        tableBody.innerHTML = '';
        addRow();
    });

    function parseBulkRows(text) {
        return text
            .split(/\r?\n/)
            .map(line => line.trim())
            .filter(Boolean)
            .map(line => {
                let parts;
                if (line.includes('\t')) {
                    parts = line.split('\t');
                } else if (line.includes(';')) {
                    parts = line.split(';');
                } else {
                    parts = line.split(',');
                }
                parts = parts.map(part => part.trim());
                return { article: parts[0] || '', value: normalizeDecimalInput(parts[1] || '') };
            })
            .filter(row => row.article || row.value);
    }

    function applyBulkRows(rows) {
        if (!rows.length) return;
        tableBody.innerHTML = '';
        rows.forEach(row => addRow(row.article, row.value));
        renumberRows();
    }

    pasteRowsButton.addEventListener('click', () => {
        const rows = parseBulkRows(bulkPaste.value);
        applyBulkRows(rows);
    });

    tableBody.addEventListener('paste', (event) => {
        const text = event.clipboardData.getData('text');
        if (!text || !text.includes('\n')) return;
        event.preventDefault();
        const rows = parseBulkRows(text);
        applyBulkRows(rows);
    });

    function normalizeDecimalInput(value) {
        return (value || '').replace(/,/g, '.');
    }

    tableBody.addEventListener('input', (event) => {
        if (event.target && event.target.name === 'cip_value') {
            const normalized = normalizeDecimalInput(event.target.value);
            if (normalized !== event.target.value) {
                event.target.value = normalized;
            }
        }
    });

    renumberRows();
</script>
<script>
    const themeToggle = document.getElementById('theme-toggle');
    const storedTheme = localStorage.getItem('cip-theme');
    if (storedTheme === 'dark') {
        document.body.classList.add('theme-dark');
    }
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('theme-dark');
        localStorage.setItem('cip-theme', document.body.classList.contains('theme-dark') ? 'dark' : 'light');
    });
</script>
<script>
    function syncCcFlags() {
        if (saleslineSelect.value === 'CC') {
            allVariantsSelect.value = 'FALSE';
            allBundlesSelect.value = 'FALSE';
            allVariantsSelect.disabled = true;
            allBundlesSelect.disabled = true;
        } else {
            allVariantsSelect.disabled = false;
            allBundlesSelect.disabled = false;
            allVariantsSelect.value = '';
            allBundlesSelect.value = '';
        }
    }

    saleslineSelect.addEventListener('change', syncCcFlags);
    syncCcFlags();
</script>

</body>
</html>
